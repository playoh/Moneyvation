<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.moneyvation.dao.GoalMapper">

    <!-- ========================= -->
    <!-- 목표 생성 -->
    <!-- ========================= -->
    <insert id="insertGoal" useGeneratedKeys="true" keyProperty="goalId">
        INSERT INTO goal (
            title, description, author,
            start_date, end_date,
            duration,
            verification_type, min_bet, allow_failure,
            category, difficulty,
            created_at
        ) VALUES (
                     #{title}, #{description}, #{author},
                     #{startDate}, #{endDate},
                     #{duration},
                     #{verificationType}, #{minBet}, #{allowFailure},
                     #{category}, #{difficulty},
                     NOW()
                 )
    </insert>

    <!-- ========================= -->
    <!-- 목표 수정 -->
    <!-- ========================= -->
    <update id="updateGoal">
        UPDATE goal
        SET
            title = #{title},
            description = #{description},
            start_date = #{startDate},
            end_date = #{endDate},
            duration = #{duration},
            verification_type = #{verificationType},
            min_bet = #{minBet},
            allow_failure = #{allowFailure},
            category = #{category},
            difficulty = #{difficulty}
        WHERE goal_id = #{goalId}
    </update>

    <!-- ========================= -->
    <!-- 목표 삭제 -->
    <!-- ========================= -->
    <delete id="deleteGoal">
        DELETE FROM goal WHERE goal_id = #{goalId}
    </delete>

    <!-- ========================= -->
    <!-- 목표 상세 -->
    <!-- ========================= -->
    <select id="getGoal" resultType="org.example.moneyvation.vo.GoalVO">
        SELECT
            goal_id AS goalId,
            title,
            description,
            author,
            start_date AS startDate,
            end_date AS endDate,
            duration,
            verification_type AS verificationType,
            min_bet AS minBet,
            allow_failure AS allowFailure,
            category,
            difficulty,
            created_at AS createdAt,

            0 AS totalParticipants,
            0 AS totalBetAmount,
            50 AS successRate,
            50 AS failureRate,

            DATEDIFF(DATE_ADD(created_at, INTERVAL duration DAY), NOW()) AS daysRemaining
        FROM goal
        WHERE goal_id = #{goalId}
    </select>

    <!-- ========================= -->
    <!-- 목표 목록 (기본 홈) -->
    <!-- ========================= -->
    <select id="getGoalList" resultType="org.example.moneyvation.vo.GoalVO">
        SELECT
            goal_id AS goalId,
            title,
            description,
            author,
            start_date AS startDate,
            end_date AS endDate,
            duration,
            verification_type AS verificationType,
            min_bet AS minBet,
            allow_failure AS allowFailure,
            category,
            difficulty,
            created_at AS createdAt,
            DATEDIFF(DATE_ADD(created_at, INTERVAL duration DAY), NOW()) AS daysRemaining
        FROM goal
        ORDER BY goal_id DESC
    </select>

    <!-- ========================= -->
    <!-- 내가 만든 목표 -->
    <!-- ========================= -->
    <select id="getGoalsByAuthor" resultType="org.example.moneyvation.vo.GoalVO">
        SELECT
            goal_id AS goalId,
            title,
            description,
            author,
            start_date AS startDate,
            end_date AS endDate,
            duration,
            verification_type AS verificationType,
            min_bet AS minBet,
            allow_failure AS allowFailure,
            category,
            difficulty,
            created_at AS createdAt,
            DATEDIFF(DATE_ADD(created_at, INTERVAL duration DAY), NOW()) AS daysRemaining
        FROM goal
        WHERE author = #{author}
        ORDER BY goal_id DESC
    </select>

    <!-- ========================= -->
    <!-- 홈 정렬 + 통계 -->
    <!-- ========================= -->
    <select id="getGoalListSorted" resultType="org.example.moneyvation.vo.GoalVO">
        SELECT
        g.goal_id AS goalId,
        g.title,
        g.description,
        g.author,
        g.start_date AS startDate,
        g.end_date AS endDate,
        g.duration,
        g.verification_type AS verificationType,
        g.min_bet AS minBet,
        g.allow_failure AS allowFailure,
        g.category,
        g.difficulty,
        g.created_at AS createdAt,

        DATEDIFF(DATE_ADD(g.created_at, INTERVAL g.duration DAY), NOW()) AS daysRemaining,

        IFNULL(b.totalParticipants, 0) AS totalParticipants,
        IFNULL(b.totalBetAmount, 0) AS totalBetAmount,

        CASE
        WHEN IFNULL(b.totalParticipants, 0) = 0 THEN 0
        ELSE ROUND(IFNULL(b.successCount, 0) * 100.0 / b.totalParticipants)
        END AS successRate,

        CASE
        WHEN IFNULL(b.totalParticipants, 0) = 0 THEN 0
        ELSE 100 - ROUND(IFNULL(b.successCount, 0) * 100.0 / b.totalParticipants)
        END AS failureRate

        FROM goal g
        LEFT JOIN (
        SELECT
        goal_id,
        COUNT(*) AS totalParticipants,
        SUM(amount) AS totalBetAmount,
        SUM(CASE WHEN bet_type = 'SUCCESS' THEN 1 ELSE 0 END) AS successCount
        FROM bets
        GROUP BY goal_id
        ) b ON b.goal_id = g.goal_id

        <choose>
            <when test="sort == 'popular'">
                ORDER BY b.totalParticipants DESC, g.goal_id DESC
            </when>
            <when test="sort == 'highest'">
                ORDER BY b.totalBetAmount DESC, g.goal_id DESC
            </when>
            <when test="sort == 'ending'">
                ORDER BY DATEDIFF(DATE_ADD(g.created_at, INTERVAL g.duration DAY), NOW()) ASC, g.goal_id DESC
            </when>
            <otherwise>
                ORDER BY g.goal_id DESC
            </otherwise>
        </choose>
    </select>

</mapper>
